
<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js ie6" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8" lang="en"> <![endif]-->
<!--[if gt IE 8]><!-->  <html class="no-js" lang="en"> <!--<![endif]-->
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	
	<title>NYC Tech Talks - OUTLOUD.FM</title>
	
	<!-- Core and extension CSS files -->
	<link rel="stylesheet" href="prettify.css">
	<link rel="stylesheet" href="../core/deck.core.css">
	<link rel="stylesheet" href="../extensions/goto/deck.goto.css">
	<link rel="stylesheet" href="../extensions/menu/deck.menu.css">
	<link rel="stylesheet" href="../extensions/navigation/deck.navigation.css">
	<link rel="stylesheet" href="../extensions/status/deck.status.css">
	<link rel="stylesheet" href="../extensions/hash/deck.hash.css">
	
	<!-- Theme CSS files (menu swaps these out) -->
	<link rel="stylesheet" id="style-theme-link" href="../themes/style/web-2.0.css">
	<link rel="stylesheet" id="transition-theme-link" href="../themes/transition/horizontal-slide.css">
	
	<!-- Custom CSS just for this page -->
	<link rel="stylesheet" href="introduction.css">
	<script src="../modernizr.custom.js"></script>
	<script src="prettify.js"></script>
</head>

<body class="deck-container" onload="prettyPrint()">

<div class="theme-menu"><!--{{{-->
	<h2>Themes</h2>	
	
	<label for="style-themes">Style:</label>
	<select id="style-themes">
		<option selected value="../themes/style/web-2.0.css">Web 2.0</option>
		<option value="../themes/style/swiss.css">Swiss</option>
		<option value="../themes/style/neon.css">Neon</option>
		<option value="">None</option>
	</select>
	
	<label for="transition-themes">Transition:</label>
	<select id="transition-themes">
		<option selected value="../themes/transition/horizontal-slide.css">Horizontal Slide</option>
		<option value="../themes/transition/vertical-slide.css">Vertical Slide</option>
		<option value="../themes/transition/fade.css">Fade</option>
		<option value="">None</option>
	</select>
</div><!--}}}-->

<div class="slide" id="title-slide"><!--{{{-->
	<h1>NYC Tech Talks - OUTLOUD.FM</h1>
</div><!--}}}-->

<div class="slide" id="introduction">
	<h2>Introduction</h2>
	<ul>
    <li>
			<h3>outloud.fm is:</h3>
      <p>A site for social, collaborative sharing of music in <b>real-time</b></p>
		</li>
    <li class="slide">
      <p>Built over nights and weekends starting in march 2011</p>
		</li>
    <li class="slide">
      <p>over 100,000+ songs uploaded</p>
		</li>
    <li class="slide">
      <p>about 6,000 active users</p>
		</li>
    <li class="slide">
      <p>over 8,000 songs "liked" (added to favorites list)</p>
		</li>
	</ul>
</div>

<div class="slide" id="introduction">
	<h2>What we'll talk about</h2>
	<ul>
    <li>
			<h3>Overall architecture</h3>
		</li>
    <li>
      <h3>Some useful lessons learned</h2>
      <ul>
        <li>How to use redis as a messaging hub</li>
        <li>Pros/Cons of using node.js and a few notes on using it in production</li>
      </ul>
    </li>
    <li>
      <h3>How MP3 Streaming works</h3>
    </li>
	</ul>
</div>


<div class="slide" id="arch-tech-overview">
	<h2>Technologies</h2>
	<ul>
    <li class="slide">
      <h3>outloud.fm is hosted on Linode.com </h3>
      <p> <img src="http://www.linode.com/images/linode_logo_gray.png"></img> </p>
		</li>
		<li class="slide">
			<h3>Streaming Servers + Application Servers are built (mostly) on node.JS</h3>
      <p> <img src="http://nodejs.org/logos/nodejs-black.png"/> </p>
		</li>

		<div class="slide">
      <p>(with a little help from python)</p>
		</div>

		<li class="slide">
			<h3>We use redis (redis.io) for persistence and messaging</h3>
      <p> <img width="300px" src="http://www.thebigbugtheory.com/wp-content/uploads/2010/12/82.png"/> </p>
		</li>
	</ul>
</div>

<div class="slide" id="arch-stuff">
  <h2>Architecture - High Level</h2>
  <ul>
    <li class="slide">Application Server (Node.JS) handles basic http request and chat connections</li>
    <li class="slide">Streaming Server (Node.JS) loads MP3 Files from the filesystem and serves them in real time</li>
    <li class="slide">Several task processors (python + other stuff) consume messages from a messaging queue + process jobs</li>
    <li class="slide">All of these components talk to each other via Redis <b>(details on this later)</b></li>
  </ul>
</div>

<div class="slide" id="archdiagram">
  <img src="outloud_arch.png" alt="" />
</div>

<div class="slide" id="redis-messaging">
  <h2>Messaging - For <b>real-time</b> events throughout the site</h2>
  <ul>
    <li><p>Upload Finished &rarr; Notify preprocessor(s) that a new file is ready</p></li>
    <li><p>Preprocessing Finished &rarr; Notify streaming server(s) that a new file is on the queue</p></li>
    <li><p>Incoming Chat Message &rarr; Notify users in the channel</p></li>
    <li><p>User enters or exits a Channel &rarr; Notify users in the chanel</p></li>
    <li><p>User "likes" a song &rarr; Notify users in the channel</p></li>
    <li><p>User deletes or adds to the queue &rarr; Update channel queue page</p></li>
    <li><p>Songs start or end &rarr; Update the "now playing" info</p></li>
  </ul>
</div>

<div class="slide" id="messaginghow1">
  <h2>Method One: Publish/Subscribe</h2>
  <ul>
    <li class="slide">
    <p>Your process(es) connect to redis and call <b>redisClient.subscribe(&lt;channel&gt;)</b></p>
      <p>Attach an event handler (callback) to the "message" event for your pub/sub client</p>
    </li>

    <li class="slide">
      <p>Then from any other redis connection, call redisClient.publish(&lt;channel&gt;, &lt;message&gt;)</p>
    </li>

    <li class="slide">
      <p>When a message is published, the "message" event will be fired on any process subscribed to that channel</p>
    </li>

    <li class="slide">
      <p>Redis can efficiently handle thousands+ of distinct channels</p>
    </li>

    <li class="slide">
      <p>The "message" is just a string, so you can use JSON/Protocol Buffers/Whatever serialization you like (we use json)</p>
    </li>
  </ul>
</div>

<!-- Put a code sample here -->
<!--pubsubClient.subscribe("chatmessage");-->

<div class="slide" id="messaginghow2">
  <h2>Method Two: Lists and BLPOP/BRPOP</h2>
  <p>Great for messaging to processes that aren't event-based (python, etc)</p>
  <p>Excellent for a barebones <b>messaging queue</b> - run as many producers/consumers as you want</p>
  <ul>
    <li class="slide">Redis has a LIST datatype which supports O(1) push/pop from either end of the list: (LPUSH/LPOP and RPUSH/RPOP)</li>

    <li class="slide">These data types also support blocking pop: BLPOP, BRPOP, BRPOPLPUSH: the process will block until there's an item available to pop from the list</li>
    <li class="slide">Producers put messages onto the queue with RPUSH, consumers process them by calling LPOP</li>
    <li class="slide">In NodeJS (Application Server), after an upload completes, we queue up a message saying "upload is done!" like this:
    <pre>
      <code class="prettyprint">
        fileUpload.on("filedone", function(){
          var uploadedFileInfo = JSON.stringify({"path":fullPath,
                                                 "room":roomname, 
                                                 "uploader":uploaderInfo.name,
                                                 "uid":uploaderInfo.uidkey,
                                                 "fname":fname});
          redisClient.rpush("newsongready", uploadedFileInfo);
        });
      </code>
    </pre>
    
    
    
    </li>
    <li class="slide">Our python code for preprocessor looks like this:
      <pre><code class="prettyprint">
      while True:
        try:
          message = r.blpop("newsongready");
          songInfo = json.loads(message[1])
          parsedFile = loadMetaData(songInfo)
          processFile(parsedFile, songInfo, outputDir)
        except Exception, e: 
          print "Couldn't parse audio information, skipping:", e
          traceback.print_exc(file=sys.stdout)
      </code></pre>
    </li>
  </ul>
</div>




<div class="slide" id="whynodejs">
	<h2>Why Node.JS ?</h2>
	<ul>
    <li class="slide"> <p>Good performance while handling lots of concurrent connections</p> </li>
    <li class="slide"> <p>Easy to re-use code between the front-end and backend</p> </li>
    <li class="slide"> <p>Simple to get access at the protocol/socket level <b>(helpful for streaming!)</b></p> </li>
    <li class="slide"> <p>Writing asynchronous/event driven code is baked into the language, not a library or plugin (e.g. Twisted)</p> </li>
    <li class="slide"> <p>Helpful and active community, with lots of libraries out there</p> </li>
    <li class="slide"> <p>Javascript is fun</p> </li>
    <li class="slide"> <p>Node is so hip and I wanted to learn it</p> </li>
  </ul>
</div>

<div class="slide" id="whynodejs">
	<h2>Node gotchas</h2>
  <ul>
    <li>Chaining lots of callbacks gets ugly + hard to read! Break them out into reusable functions or use helper libs (async.js?)</li>
    <li>Single threaded... (nginx/haproxy in front?)</li>
    <li>Low-level can be a pain</li>
    <li>API is changing really quickly</li>
    <li>Debugging can be tricky, and NodeJS itself is young and may still have bugs, as well as its libraries</li>
    <li>Javascript is a drag sometimes (switch to Coffeescript maybe? whatever)</li>
  </ul>
</div>

<div class="slide" id="mp3stuff">
	<h2>MP3 Spec</h2>
  <div class="slide">
    <div style="padding:20px;border:1px solid black; text-align:center; width:300px;">Zero or more ID3v2 Items</div>
    <div style="padding:20px;border:1px solid black; text-align:center; width:300px;">1 or more MP3 Frames<br/>&#x22ee;<br/>&#x22ee;</div>
    <div style="padding:20px;border:1px solid black; text-align:center; width:300px;">Optional 128 Byte ID3v1 Header, always starts with "TAG"</div>
  </div>

  <div class="slide">
    <h3>ID3v2 are delimited chunks of data with "tags" to indicate what kind of data they have</h3>
    <table cellspacing="0">
      <tr><td>AENC</td>    <td>[#sec4.20 Audio encryption] </td></tr>
      <tr><td>APIC</td>    <td>[#sec4.15 Attached picture]</td></tr>
      <tr><td>COMM</td>    <td>[#sec4.11 Comments]</td></tr>
      <tr><td>COMR</td>    <td>[#sec4.25 Commercial frame]</td></tr>
      <tr><td>ENCR</td>    <td>[#sec4.26 Encryption method registration]</td></tr>
      <tr>
        <td colspan="2">etc... (LOTS more)</td>
      </tr>
    </table>
  
  </div>
</div>


<a href="#" class="deck-prev-link" title="Previous">&#8592;</a>
<a href="#" class="deck-next-link" title="Next">&#8594;</a>

<p class="deck-status">
	<span class="deck-status-current"></span>
	/
	<span class="deck-status-total"></span>
</p>

<form action="." method="get" class="goto-form">
	<label for="goto-slide">Go to slide:</label>
	<input type="number" name="slidenum" id="goto-slide">
	<input type="submit" value="Go">
</form>

<a href="." title="Permalink to this slide" class="deck-permalink">#</a>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.1/jquery.js"></script>
<script>window.jQuery || document.write('<script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.6.1.min.js">\x3C/script>')</script>

<!-- Deck Core and extensions -->
<script src="../core/deck.core.js"></script>
<script src="../extensions/menu/deck.menu.js"></script>
<script src="../extensions/goto/deck.goto.js"></script>
<script src="../extensions/status/deck.status.js"></script>
<script src="../extensions/navigation/deck.navigation.js"></script>
<script src="../extensions/hash/deck.hash.js"></script>

<!-- Specific to this page -->
<script src="introduction.js"></script>

</body>
</html>
